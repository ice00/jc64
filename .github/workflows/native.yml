name: Build Native Executables

on:
  push:
    branches:
      - master

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      #######################################################################
      # LINUX BUILD
      #######################################################################
      - name: Install Liberica Full and run native-image (Linux)
        if: runner.os == 'Linux'
        run: |
          set -euo pipefail

          URL="https://download.bell-sw.com/vm/25.0.1/bellsoft-liberica-vm-full-openjdk25.0.1+16-25.0.1+3-linux-amd64.tar.gz"
          TARBALL=$(basename "$URL")

          curl -fSL --retry 5 --retry-delay 5 -C - -o "$TARBALL" "$URL"
          sudo mkdir -p /opt
          sudo tar -xzf "$TARBALL" -C /opt

          EX_DIR=$(ls -1 /opt | grep -E '^bellsoft-liberica' | head -n 1)
          LIB_DIR="/opt/${EX_DIR}"

          sudo apt-get update
          sudo apt-get install -y libx11-6 libxext6 libxrender1 libxtst6 libxi6 libxrandr2 libxcursor1 fontconfig ca-certificates
          sudo apt-get install -y libasound2 libpulse0 || true

          export PATH="${LIB_DIR}/bin:$PATH"
          export JAVA_HOME="${LIB_DIR}"

          ant -f build-github.xml jar

          native-image \
            -J-Djava.home=${JAVA_HOME} \
            -J-Djavax.sound.config.file=./conf/sound.properties \
            -Djava.awt.headless=false \
            --no-fallback \
            -H:ConfigurationFileDirectories=native-image-config \
            -H:IncludeResources='conf/sound.properties|org/fife/ui/rsyntaxtextarea/.*|META-INF/services/.*' \
            --initialize-at-build-time=com.sun.media.sound.PortMixerProvider,com.sun.media.sound.DirectAudioDeviceProvider \
            --report-unsupported-elements-at-runtime \
            -jar dist/jc64.jar jc64

      #######################################################################
      # WINDOWS BUILD
      #######################################################################
      - name: Install GraalVM (Windows)
        if: runner.os == 'Windows'
        uses: graalvm/setup-graalvm@v1
        with:
          distribution: 'graalvm'
          java-version: '17'
          components: 'native-image'

      - name: Build JAR (Windows)
        if: runner.os == 'Windows'
        run: ant -f build-github.xml jar


      - name: Build Native Image (Windows)
        if: runner.os == 'Windows'
        run: |
          native-image `
            "-J-Djava.home=$env:JAVA_HOME" `
            "-J-Djavax.sound.config.file=./conf/sound.properties" `
            "-Djava.awt.headless=false" `
            "--no-fallback" `
            "-H:ConfigurationFileDirectories=native-image-config" `
            "-H:IncludeResources=conf/sound.properties" `
            "-H:IncludeResources=org/fife/ui/rsyntaxtextarea/.*" `
            "-H:IncludeResources=META-INF/services/.*" `
            "--initialize-at-build-time=com.sun.media.sound.PortMixerProvider" `
            "--initialize-at-build-time=com.sun.media.sound.DirectAudioDeviceProvider" `
            "--report-unsupported-elements-at-runtime" `
            "-jar" `
            "dist/jc64.jar" `
            "jc64.exe"

          if (Get-Command upx -ErrorAction SilentlyContinue) {
            upx --best --lzma jc64.exe
          }




      #######################################################################
      # PACKAGE LINUX RUNTIME
      #######################################################################
      - name: Package Linux runtime bundle
        if: runner.os == 'Linux'
        run: |
          set -euo pipefail

          rm -rf dist-run
          mkdir -p dist-run/bin dist-run/conf

          cp jc64 dist-run/bin/jc64
          chmod a+rx dist-run/bin/jc64

          cp -r conf/* dist-run/conf/ || true
          cp script/jc64.sh dist-run/jc64.sh
          chmod a+rx dist-run/jc64.sh

          if [ -d doc ]; then
            shopt -s dotglob
            cp -r doc/* dist-run/
            shopt -u dotglob
          fi

      - name: Upload Linux native bundle
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: jc64-native-linux
          path: dist-run

      #######################################################################
      # PACKAGE WINDOWS RUNTIME
      #######################################################################
      - name: Package Windows runtime bundle
        if: runner.os == 'Windows'
        run: |
          Remove-Item -Recurse -Force dist-run-windows -ErrorAction Ignore
          New-Item -ItemType Directory -Path dist-run-windows\bin | Out-Null
          New-Item -ItemType Directory -Path dist-run-windows\conf | Out-Null

          Copy-Item jc64.exe dist-run-windows\bin\jc64.exe

          Copy-Item conf\* dist-run-windows\conf -Recurse -ErrorAction Ignore

          if (Test-Path "script\jc64.bat") {
            Copy-Item script\jc64.bat dist-run-windows\jc64.bat
          }

          if (Test-Path "doc") {
            Copy-Item doc\* dist-run-windows -Recurse
          }

      - name: Upload Windows native bundle
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: jc64-native-windows
          path: dist-run-windows
