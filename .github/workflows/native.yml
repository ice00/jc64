name: Build Native Executables

on:
  push:
    branches:
      - master

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Linux: install Liberica Full (contains NIK) and system libs; fallback to NIK if needed ---
      - name: Install Liberica Full (Linux amd64) and system libs
        if: runner.os == 'Linux'
        run: |
          set -euo pipefail

          # URL Liberica Full (contains NIK in the Full distribution)
          URL="https://download.bell-sw.com/vm/25.0.1/bellsoft-liberica-vm-full-openjdk25.0.1+16-25.0.1+3-linux-amd64.tar.gz"
          TARBALL=$(basename "$URL")

          echo "Downloading Liberica Full from: $URL"
          curl -fSL --retry 5 --retry-delay 5 -C - -o "$TARBALL" "$URL"

          echo "Downloaded file size:"
          ls -lh "$TARBALL"

          echo "MIME type:"
          file --brief --mime-type "$TARBALL" || true

          echo "Tar listing (first 40 entries):"
          tar -tzf "$TARBALL" | head -n 40 || true

          sudo mkdir -p /opt
          sudo tar -xzf "$TARBALL" -C /opt

          EX_DIR=$(tar -tzf "$TARBALL" | head -1 | cut -f1 -d"/")
          echo "/opt/${EX_DIR}/bin" >> $GITHUB_PATH
          echo "JAVA_HOME=/opt/${EX_DIR}" >> $GITHUB_ENV
          sudo chmod -R a+rx /opt/${EX_DIR}/bin

          # Install system libs required by AWT/Swing
          sudo apt-get update
          sudo apt-get install -y libx11-6 libxext6 libxrender1 libxtst6 libxi6 libxrandr2 libxcursor1 fontconfig ca-certificates

          # Verify native-image presence; if missing, download NIK Full as fallback
          if ! command -v native-image >/dev/null 2>&1; then
            echo "native-image non trovato nella Liberica Full. Scarico NIK Full (fallback)."

            NIK_VERSION=22.3.1
            NIK_TARBALL=bellsoft-liberica-nik-full-${NIK_VERSION}-linux-amd64.tar.gz
            NIK_URL="https://download.bell-sw.com/native-image-kit/${NIK_VERSION}/${NIK_TARBALL}"

            echo "Downloading NIK from: ${NIK_URL}"
            curl -fSL --retry 5 --retry-delay 5 -C - -o "${NIK_TARBALL}" "${NIK_URL}"

            echo "Checking MIME type for NIK tarball:"
            file --brief --mime-type "${NIK_TARBALL}" || true

            echo "Tar listing for NIK (first 40 entries):"
            tar -tzf "${NIK_TARBALL}" | head -n 40 || true

            sudo tar -xzf "${NIK_TARBALL}" -C /opt
            NIK_DIR=$(tar -tzf "${NIK_TARBALL}" | head -1 | cut -f1 -d"/")
            echo "/opt/${NIK_DIR}/bin" >> $GITHUB_PATH
            echo "JAVA_HOME=/opt/${NIK_DIR}" >> $GITHUB_ENV
            sudo chmod -R a+rx /opt/${NIK_DIR}/bin

            echo "NIK installed to /opt/${NIK_DIR}"
          else
            echo "native-image trovato: $(which native-image)"
          fi

      # --- macOS and Windows: install GraalVM native-image as before ---
      - name: Install GraalVM (macOS and Windows)
        if: runner.os != 'Linux'
        uses: graalvm/setup-graalvm@v1
        with:
          distribution: 'graalvm'
          java-version: '17'
          components: 'native-image'

      # Install UPX
      - name: Install UPX (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y upx

      - name: Install UPX (macOS)
        if: runner.os == 'macOS'
        run: brew install upx

      - name: Install UPX (Windows)
        if: runner.os == 'Windows'
        run: choco install upx

      # Build JAR (fat jar) using Ant
      - name: Build JAR with Ant
        run: ant -f build-github.xml jar

      # Upload JAR artifact
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: jc64-jar-${{ runner.os }}
          path: dist/jc64.jar

      # Verify native-image (Linux) - optional extra check
      - name: Verify native-image (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "PATH: $PATH"
          which native-image || true
          native-image --version

      # Native Image build Linux using Liberica Full / NIK
      - name: Build Native Image (Linux with Liberica/NIK)
        if: runner.os == 'Linux'
        run: |
          set -euo pipefail
          echo "Using native-image from: $(which native-image || true)"
          native-image -Djava.awt.headless=false --no-fallback -H:ConfigurationFileDirectories=native-image-config -jar dist/jc64.jar jc64

      # Native Image build macOS using GraalVM (unchanged)
      - name: Build Native Image (macOS)
        if: runner.os == 'macOS'
        run: native-image --no-fallback -H:ConfigurationFileDirectories=native-image-config -jar dist/jc64.jar jc64

      # Native Image build Windows using GraalVM (unchanged)
      - name: Build Native Image (Windows)
        if: runner.os == 'Windows'
        run: native-image --no-fallback -H:ConfigurationFileDirectories=native-image-config -jar dist/jc64.jar jc64

      # UPX compression
      - name: Compress with UPX (Linux)
        if: runner.os == 'Linux'
        run: upx --best --lzma jc64

      - name: Compress with UPX (Windows)
        if: runner.os == 'Windows'
        run: upx --best --lzma jc64.exe

      - name: Skip UPX on macOS
        if: runner.os == 'macOS'
        run: echo "UPX not supported on macOS, skipping"

      # Upload final executable
      - name: Upload Native Executable
        uses: actions/upload-artifact@v4
        with:
          name: jc64-native-${{ runner.os }}
          path: jc64*
