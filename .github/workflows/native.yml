name: Build Native Executables

on:
  push:
    branches:
      - master

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      #######################################################################
      # LINUX BUILD
      #######################################################################
      - name: Install Liberica Full and run native-image (Linux)
        if: runner.os == 'Linux'
        run: |
          set -euo pipefail

          URL="https://download.bell-sw.com/vm/25.0.1/bellsoft-liberica-vm-full-openjdk25.0.1+16-25.0.1+3-linux-amd64.tar.gz"
          TARBALL=$(basename "$URL")

          curl -fSL --retry 5 --retry-delay 5 -C - -o "$TARBALL" "$URL"
          sudo mkdir -p /opt
          sudo tar -xzf "$TARBALL" -C /opt

          EX_DIR=$(ls -1 /opt | grep -E '^bellsoft-liberica' | head -n 1)
          LIB_DIR="/opt/${EX_DIR}"

          sudo apt-get update
          sudo apt-get install -y libx11-6 libxext6 libxrender1 libxtst6 libxi6 libxrandr2 libxcursor1 fontconfig ca-certificates
          sudo apt-get install -y libasound2 libpulse0 || true

          export PATH="${LIB_DIR}/bin:$PATH"
          export JAVA_HOME="${LIB_DIR}"

          ant -f build-github.xml jar

          native-image \
            -J-Djava.home=${JAVA_HOME} \
            -J-Djavax.sound.config.file=./conf/sound.properties \
            -Djava.awt.headless=false \
            --no-fallback \
            -H:ConfigurationFileDirectories=native-image-config \
            -H:IncludeResources='conf/sound.properties|org/fife/ui/rsyntaxtextarea/.*|META-INF/services/.*' \
            --initialize-at-build-time=com.sun.media.sound.PortMixerProvider,com.sun.media.sound.DirectAudioDeviceProvider \
            --report-unsupported-elements-at-runtime \
            -jar dist/jc64.jar jc64

      #######################################################################
      # WINDOWS BUILD (Liberica VM Full + native-image.cmd)
      #######################################################################
      - name: Install Liberica Full VM (Windows)
        if: runner.os == 'Windows'
        run: |
          $url = "https://download.bell-sw.com/vm/25.0.1/bellsoft-liberica-vm-full-openjdk25.0.1+16-25.0.1+3-windows-amd64.zip"
          $zip = "liberica.zip"

          Invoke-WebRequest -Uri $url -OutFile $zip
          Expand-Archive -Path $zip -DestinationPath "C:\Liberica" -Force

          # trova la directory estratta
          $dir = Get-ChildItem "C:\Liberica" | Where-Object { $_.PSIsContainer } | Select-Object -First 1
          $libDir = $dir.FullName

          echo "Liberica installed at: $libDir"

          # imposta JAVA_HOME e PATH
          echo "JAVA_HOME=$libDir" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "$libDir\bin" | Out-File -FilePath $env:GITHUB_PATH -Append


      - name: Build JAR (Windows)
        if: runner.os == 'Windows'
        run: ant -f build-github.xml jar


      - name: Build Native Image (Windows)
        if: runner.os == 'Windows'
        run: |
          native-image.cmd `
            "-J-Djava.home=$env:JAVA_HOME" `
            "-J-Djavax.sound.config.file=./conf/sound.properties" `
            "-Djava.awt.headless=false" `
            --no-fallback `
            -H:ConfigurationFileDirectories=native-image-config `
            -H:IncludeResources=conf/sound.properties `
            -H:IncludeResources=org/fife/ui/rsyntaxtextarea/.* `
            -H:IncludeResources=META-INF/services/.* `
            --initialize-at-run-time=com.sun.media.sound.Platform `
            --report-unsupported-elements-at-runtime `
            -jar dist/jc64.jar `
            jc64

          if (Get-Command upx -ErrorAction SilentlyContinue) {
            upx --best --lzma jc64.exe
          }


      #######################################################################
      # MACOS BUILD (Liberica VM Full + native-image)
      #######################################################################
      - name: Install Liberica Full VM (macOS)
        if: runner.os == 'macOS'
        run: |
          set -euo pipefail

          URL="https://download.bell-sw.com/vm/25.0.1/bellsoft-liberica-vm-full-openjdk25.0.1+16-25.0.1+3-macos-amd64.zip"
          ZIP=$(basename "$URL")

          curl -fSL --retry 5 --retry-delay 5 -o "$ZIP" "$URL"

          mkdir -p "$HOME/liberica"
          unzip "$ZIP" -d "$HOME/liberica"

          EX_DIR=$(ls -1 "$HOME/liberica" | grep -E '^bellsoft-liberica' | head -n 1)
          LIB_DIR="$HOME/liberica/${EX_DIR}/Contents/Home"

          echo "JAVA_HOME=$LIB_DIR" >> $GITHUB_ENV
          echo "$LIB_DIR/bin" >> $GITHUB_PATH


      - name: Build JAR (macOS)
        if: runner.os == 'macOS'
        run: ant -f build-github.xml jar

      - name: Build Native Image (macOS)
        if: runner.os == 'macOS'
        run: |
          native-image \
            -J-Xmx6g \
            -J-Djava.home=$JAVA_HOME \
            -J-Djavax.sound.config.file=./conf/sound.properties \
            -Djava.awt.headless=false \
            --no-fallback \
            -H:ConfigurationFileDirectories=native-image-config \
            -H:IncludeResources='conf/sound.properties|org/fife/ui/rsyntaxtextarea/.*|META-INF/services/.*' \
            --initialize-at-build-time=com.sun.media.sound.PortMixerProvider,com.sun.media.sound.DirectAudioDeviceProvider \
            --report-unsupported-elements-at-runtime \
            -jar dist/jc64.jar jc64


      #######################################################################
      # PACKAGE MACOS RUNTIME
      #######################################################################
      - name: Package macOS runtime bundle
        if: runner.os == 'macOS'
        run: |
          set -euo pipefail

          rm -rf dist-run-macos
          mkdir -p dist-run-macos/bin dist-run-macos/conf

          cp jc64 dist-run-macos/bin/jc64
          chmod a+rx dist-run-macos/bin/jc64

          cp -r conf/* dist-run-macos/conf || true

          # Add launcher script
          cp script/jc64-macos.sh dist-run-macos/jc64-macos.sh
          chmod a+rx dist-run-macos/jc64-macos.sh

          if [ -d doc ]; then
            shopt -s dotglob
            cp -r doc/* dist-run-macos/
            shopt -u dotglob
          fi


      - name: Upload macOS native bundle
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: jc64-native-macos
          path: dist-run-macos


      #######################################################################
      # PACKAGE LINUX RUNTIME
      #######################################################################
      - name: Package Linux runtime bundle
        if: runner.os == 'Linux'
        run: |
          set -euo pipefail

          rm -rf dist-run
          mkdir -p dist-run/bin dist-run/conf

          cp jc64 dist-run/bin/jc64
          chmod a+rx dist-run/bin/jc64

          # Copy native libs from Liberica Full (AWT, fontmanager, etc.)
          if [ -d "$JAVA_HOME/lib" ]; then
              echo "Copying native libs from $JAVA_HOME/lib..."
              cp "$JAVA_HOME"/lib/*.so dist-run/bin/ 2>/dev/null || true
          fi

          # Copy libs generated by native-image (if any)
          if [ -d jc64.build_artifacts ]; then
              echo "Copying native-image generated libs..."
              cp jc64.build_artifacts/*.so dist-run/bin/ 2>/dev/null || true
              if [ -d jc64.build_artifacts/lib ]; then
                  cp jc64.build_artifacts/lib/*.so dist-run/bin/ 2>/dev/null || true
              fi
          fi


          cp -r conf/* dist-run/conf/ || true
          cp script/jc64.sh dist-run/jc64.sh
          chmod a+rx dist-run/jc64.sh

          if [ -d doc ]; then
            shopt -s dotglob
            cp -r doc/* dist-run/
            shopt -u dotglob
          fi

      - name: Upload Linux native bundle
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: jc64-native-linux
          path: dist-run

      #######################################################################
      # PACKAGE WINDOWS RUNTIME
      #######################################################################
      - name: Package Windows runtime bundle
        if: runner.os == 'Windows'
        run: |
          Remove-Item -Recurse -Force dist-run-windows -ErrorAction Ignore
          New-Item -ItemType Directory -Path dist-run-windows\bin | Out-Null
          New-Item -ItemType Directory -Path dist-run-windows\conf | Out-Null

          # trova l'eseguibile
          $exe = Get-ChildItem -Recurse -Filter "jc64*.exe" | Select-Object -First 1
          if (-not $exe) {
            Write-Error "ERROR: Could not find jc64.exe anywhere in workspace"
            exit 1
          }

          # copia exe
          Copy-Item $exe.FullName dist-run-windows\bin\jc64.exe

          # copia tutte le dll native generate da native-image nella stessa dir
          Get-ChildItem -Path $exe.DirectoryName -Filter "*.dll" | ForEach-Object {
            Copy-Item $_.FullName dist-run-windows\bin\
          }

          # conf
          Copy-Item conf\* dist-run-windows\conf -Recurse -ErrorAction Ignore

          # wrapper .bat
          if (Test-Path "script\jc64.bat") {
            Copy-Item script\jc64.bat dist-run-windows\jc64.bat
          }

          # doc
          if (Test-Path "doc") {
            Copy-Item doc\* dist-run-windows -Recurse
          }


      - name: Upload Windows native bundle
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: jc64-native-windows
          path: dist-run-windows

      #######################################################################
      # BUILD UNIVERSAL JAR (OpenJDK 25)
      #######################################################################
      - name: Install OpenJDK 25
        if: runner.os == 'Linux'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'

      - name: Build JAR with OpenJDK 25
        if: runner.os == 'Linux'
        run: |
          ant -f build-github.xml clean jar

          rm -rf dist-jar
          mkdir -p dist-jar

          # Copy JAR
          cp dist/jc64.jar dist-jar/

          # Copy scripts to root
          if [ -f script/jc64dis.sh ]; then cp script/jc64dis.sh dist-jar/; fi
          if [ -f script/jc64dis.bat ]; then cp script/jc64dis.bat dist-jar/; fi

          # Copy conf
          if [ -d conf ]; then cp -r conf dist-jar/; fi

          # Copy doc as-is
          if [ -d doc ]; then cp -r doc dist-jar/; fi

          # Extract jc64dis.pdf from doc/ to root
          if [ -f dist-jar/doc/jc64dis.pdf ]; then
            mv dist-jar/doc/jc64dis.pdf dist-jar/
          fi

          # Extract example/*.dis from doc/example/ to root/examples/
          if [ -d dist-jar/doc/example ]; then
            mkdir -p dist-jar/examples
            mv dist-jar/doc/example/* dist-jar/examples/
            rmdir dist-jar/doc/example || true
          fi


      - name: Upload JAR bundle
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: jc64-jar
          path: dist-jar

  publish-latest:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Delete previous 'latest' release
        run: |
          gh release delete latest -y || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete previous 'latest' tag
        run: |
          git push origin :refs/tags/latest || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create new 'latest' tag
        run: |
          git tag latest
          git push origin latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create new 'latest' release
        run: |
          gh release create latest \
            --title "Latest development build" \
            --notes "Build automatic from GitHub Actions"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Zip artifacts
        run: |
          cd artifacts
          for dir in */ ; do
            name="${dir%/}"
            zip -r "../${name}.zip" "$name"
          done

      - name: Upload artifacts to latest release
        run: |
          gh release upload latest *.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

