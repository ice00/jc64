
name: Build Native Executables

on:
  push:
    branches:
      - master

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Linux: install Liberica NIK; macOS/Windows: keep GraalVM setup as before ---
           - name: Install Liberica Full (Linux amd64)
        if: runner.os == 'Linux'
        run: |
          set -euo pipefail

          # URL Liberica Full che hai fornito
          URL="https://download.bell-sw.com/vm/25.0.1/bellsoft-liberica-vm-full-openjdk25.0.1+16-25.0.1+3-linux-amd64.tar.gz"
          TARBALL=$(basename "$URL")

          echo "Downloading: $URL"
          curl -fSL -o "$TARBALL" "$URL"

          echo "Downloaded file size:"
          ls -lh "$TARBALL"

          echo "MIME type:"
          file --brief --mime-type "$TARBALL" || true

          # sanity check: show first lines of tar listing
          echo "Tar listing (first 40 entries):"
          tar -tzf "$TARBALL" | head -n 40

          # extract to /opt
          sudo mkdir -p /opt
          sudo tar -xzf "$TARBALL" -C /opt

          # find extracted dir and add bin to PATH and JAVA_HOME
          EX_DIR=$(tar -tzf "$TARBALL" | head -1 | cut -f1 -d"/")
          echo "/opt/${EX_DIR}/bin" >> $GITHUB_PATH
          echo "JAVA_HOME=/opt/${EX_DIR}" >> $GITHUB_ENV
          sudo chmod -R a+rx /opt/${EX_DIR}/bin

      - name: Install system libs required by AWT (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-6 libxext6 libxrender1 libxtst6 libxi6 libxrandr2 libxcursor1 fontconfig ca-certificates

      - name: Verify native-image (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "native-image path: $(which native-image || true)"
          if ! command -v native-image >/dev/null 2>&1; then
            echo "native-image non trovato. Se la tarball Full non include NIK, scarica NIK Full (vedi commento nel workflow)."
            exit 1
          fi
          native-image --version


      - name: Install system libs required by AWT (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-6 libxext6 libxrender1 libxtst6 libxi6 libxrandr2 libxcursor1 fontconfig ca-certificates

      - name: Verify native-image (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "PATH: $PATH"
          which native-image || true
          native-image --version


      - name: Install system libs required by AWT (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-6 libxext6 libxrender1 libxtst6 libxi6 libxrandr2 libxcursor1 fontconfig

      - name: Verify native-image (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "PATH: $PATH"
          which native-image || true
          native-image --version

      - name: Install GraalVM (macOS and Windows)
        if: runner.os != 'Linux'
        uses: graalvm/setup-graalvm@v1
        with:
          distribution: 'graalvm'
          java-version: '17'
          components: 'native-image'

      # Install UPX
      - name: Install UPX (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y upx

      - name: Install UPX (macOS)
        if: runner.os == 'macOS'
        run: brew install upx

      - name: Install UPX (Windows)
        if: runner.os == 'Windows'
        run: choco install upx

      # Build JAR (fat jar)
      - name: Build JAR with Ant
        run: ant -f build-github.xml jar

      # Upload JAR artifact
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: jc64-jar-${{ runner.os }}
          path: dist/jc64.jar

      # Native Image build Linux using Liberica NIK
      - name: Build Native Image (Linux with Liberica NIK)
        if: runner.os == 'Linux'
        env:
          JAVA_HOME: /opt/${{ steps.find_nik_dir.outputs.nik_dir }}
        run: native-image -Djava.awt.headless=false --no-fallback -H:ConfigurationFileDirectories=native-image-config -jar dist/jc64.jar jc64

      # Native Image build macOS using GraalVM (unchanged)
      - name: Build Native Image (macOS)
        if: runner.os == 'macOS'
        run: native-image --no-fallback -H:ConfigurationFileDirectories=native-image-config -jar dist/jc64.jar jc64

      # Native Image build Windows using GraalVM (unchanged)
      - name: Build Native Image (Windows)
        if: runner.os == 'Windows'
        run: native-image --no-fallback -H:ConfigurationFileDirectories=native-image-config -jar dist/jc64.jar jc64

      # UPX compression
      - name: Compress with UPX (Linux)
        if: runner.os == 'Linux'
        run: upx --best --lzma jc64

      - name: Compress with UPX (Windows)
        if: runner.os == 'Windows'
        run: upx --best --lzma jc64.exe

      - name: Skip UPX on macOS
        if: runner.os == 'macOS'
        run: echo "UPX not supported on macOS, skipping"

      # Upload final executable
      - name: Upload Native Executable
        uses: actions/upload-artifact@v4
        with:
          name: jc64-native-${{ runner.os }}
          path: jc64*
